
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seed Rankings | localStorage Initializer</title>
  <style>
    :root { --fg:#111; --bg:#fff; --ok:#0a7; --warn:#c70; --err:#c22; --muted:#666; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif;}
    main{max-width:840px;margin:32px auto;padding:24px}
    h1{font-size:20px;margin:0 0 12px}
    .box{border:1px solid #ddd;border-radius:8px;padding:16px;margin:12px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .msg{padding:12px 14px;border-left:6px solid var(--muted);background:#f9f9f9;border-radius:6px}
    .msg.ok{border-left-color:var(--ok);}
    .msg.warn{border-left-color:var(--warn);} 
    .msg.err{border-left-color:var(--err);background:#fff5f5}
    code,kbd{background:#f2f2f2;border-radius:4px;padding:2px 6px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    button{appearance:none;border:1px solid #bbb;border-radius:8px;padding:8px 12px;background:#fff;cursor:pointer}
    button.primary{border-color:#0a7;color:#0a7}
    table{border-collapse:collapse;width:100%;}
    th,td{border:1px solid #eee;padding:6px 8px;text-align:left}
    th{background:#fafafa}
    footer{margin-top:32px;color:#666;font-size:12px}
  </style>
</head>
<body>
  <main>
    <h1>ãƒ©ãƒ³ã‚­ãƒ³ã‚°åˆæœŸåŒ–ï¼ˆlocalStorage /rankingsï¼‰</h1>
    <div class="box">
      <div id="status" class="msg">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
      <div class="row" style="margin-top:8px">
        <button id="btnOpen" class="primary" hidden>ã‚²ãƒ¼ãƒ ã‚’é–‹ã</button>
        <button id="btnForce" hidden>å¼·åˆ¶ä¸Šæ›¸ãï¼ˆforce=1ï¼‰</button>
        <button id="btnClear" hidden>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å‰Šé™¤</button>
        <button id="btnView" hidden>ç¾åœ¨ã®å€¤ã‚’è¡¨ç¤º</button>
      </div>
    </div>

    <div id="output" class="box" hidden>
      <div style="font-weight:600;margin-bottom:8px">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
      <div id="preview"></div>
    </div>

    <footer>
      <div>åŒä¸€ã‚ªãƒªã‚¸ãƒ³ã® <code>localStorage['rankings']</code> ã« <code>rankings.seed.json</code> ã‚’æŠ•å…¥ã—ã¾ã™ã€‚</div>
      <div>URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼š<code>?force=1</code>ï¼ˆæ—¢å­˜ã‚’ç„¡è¦–ã—ã¦ä¸Šæ›¸ãï¼‰ã€<code>?url=/score/rankings.seed.json</code>ï¼ˆèª­ã¿è¾¼ã¿å…ˆã®ä¸Šæ›¸ãï¼‰</div>
    </footer>
  </main>

<script>
(async () => {
  const KEY = 'rankings';
  const $ = (sel)=>document.querySelector(sel);
  const status = $('#status');
  const output = $('#output');
  const preview = $('#preview');
  const btnOpen = $('#btnOpen');
  const btnForce = $('#btnForce');
  const btnClear = $('#btnClear');
  const btnView = $('#btnView');

  const usp = new URLSearchParams(location.search);
  const force = usp.has('force') && usp.get('force') !== '0';
  const seedURL = usp.get('url') || '/score/rankings.seed.json';
  const gameURL = usp.get('to') || '/';

  function setMsg(html, cls=''){
    status.className = 'msg ' + cls;
    status.innerHTML = html;
  }

  function safeParse(str){
    try { return JSON.parse(str); } catch(e){ return null; }
  }

  function validate(arr){
    if (!Array.isArray(arr)) throw new Error('JSON ã¯é…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
    const clamp = (n,min,max)=>Math.min(max,Math.max(min,n));
    const out = [];
    for (const e of arr){
      if (typeof e !== 'object' || e===null) throw new Error('è¦ç´ ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã‚ã‚Šã¾ã›ã‚“');
      const name = String(e.name ?? '').trim();
      const score = Number(e.score);
      const scoreAt = Number(e.scoreAt);
      if (!/^([A-Za-z0-9]{1,10})$/.test(name)) throw new Error('name ãŒä¸æ­£: ' + name);
      if (!Number.isFinite(score)) throw new Error('score ãŒæ•°å€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
      if (!Number.isFinite(scoreAt)) throw new Error('scoreAt ãŒæ•°å€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
      out.push({ name, score: clamp(Math.trunc(score), 0, 99_999_999), scoreAt: Math.trunc(scoreAt) });
    }
    return out;
  }

  async function loadSeed(url){
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json();
    return validate(json);
  }

  function showPreview(list, title='ç¾åœ¨ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°'){
    output.hidden = false;
    const rows = list.map((e,i)=>`<tr><td>${i+1}</td><td>${e.name}</td><td style="text-align:right">${e.score.toLocaleString()}</td><td>${new Date(e.scoreAt).toLocaleString()}</td></tr>`).join('');
    preview.innerHTML = `<div style="margin-bottom:6px">${title}ï¼ˆ${list.length}ä»¶ï¼‰</div>`+
      `<table><thead><tr><th>#</th><th>Name</th><th>Score</th><th>scoreAt</th></tr></thead><tbody>${rows}</tbody></table>`;
  }

  // Buttons
  btnOpen.onclick = ()=>location.href = gameURL;
  btnForce.onclick = ()=>location.href = location.pathname + '?force=1' + (seedURL?('&url='+encodeURIComponent(seedURL)):'') + (gameURL?('&to='+encodeURIComponent(gameURL)):'');
  btnClear.onclick = ()=>{ localStorage.removeItem(KEY); setMsg('ğŸ—‘ï¸ rankings ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚å†èª­è¾¼ã§ seed ã§ãã¾ã™ã€‚','warn'); btnClear.hidden=true; };
  btnView.onclick = ()=>{
    const arr = safeParse(localStorage.getItem(KEY)) || [];
    showPreview(arr,'localStorage[\'rankings\']');
  };

  try {
    const exists = !!localStorage.getItem(KEY);
    if (exists && !force){
      setMsg('âš ï¸ localStorage["rankings"] ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚<br>å¼·åˆ¶ä¸Šæ›¸ãã™ã‚‹ã«ã¯ <code>?force=1</code> ã‚’ä»˜ã‘ã¦å†ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚','warn');
      btnForce.hidden = false; btnView.hidden=false; btnClear.hidden=false; btnOpen.hidden=false;
      showPreview(safeParse(localStorage.getItem(KEY))||[], 'localStorage[\'rankings\']');
      return;
    }

    const list = await loadSeed(seedURL);
    localStorage.setItem(KEY, JSON.stringify(list));

    setMsg(`âœ… åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆ${list.length}ä»¶ï¼‰ã€‚ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã§ãã¾ã™ã€‚`,'ok');
    btnOpen.hidden=false; btnView.hidden=false; btnClear.hidden=false;
    showPreview(list, 'æŠ•å…¥ã—ãŸãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰');
  } catch (e){
    console.error(e);
    setMsg('âŒ å¤±æ•—ï¼š' + (e && e.message ? e.message : e), 'err');
    btnView.hidden=false;
  }
})();
</script>
</body>
</html>
