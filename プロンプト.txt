# 目的
Node.js + TypeScript + Phaser 3 + Vite で、ブラウザ実行の「縦スクロール回避タイムアタック」ゲームを 1 ステージ構成で実装する。  
ノンエンジニアが Excel 管理の CSV を編集するだけで、プレイヤー設定とアイテム出現を調整できる形を目指す。  
**AIが出力するのは src/ 配下の TypeScript/Phaser/Vite 用コードのみ**。
AIは以下を一切出力しない：public/ 配下の 画像・CSV・音声・フォント・JSON・マップ・README 等の非コード資産、ならびにそれらのbase64/インライン表現。

# フォルダ構成
my-game/
 ├ node_modules/
 ├ public/                          # リソース（手動配置）
 │  ├ data/                         # アイテムフォルダ
 │  │  ├ player.csv                 # プレイヤー設定
 │  │  └ item.csv                   # アイテム定義
 │  ├ images/                       # 画像フォルダ
 │  │  ├ backGround/                # 背景フォルダ
 │  │  │  ├ BG_Build_Loop0.png      # 背景ループ用。数字はエリア番号（透過PNG）
 │  │  │  ├ BG_Title.png            # タイトルや初期配置に使う画像（透過PNG）
 │  │  │  └ BG_Ladder.png           # ４つのレーンに配置する梯子画像（透過PNG）
 │  │  ├ items/                     # アイテムの画像フォルダ
 │  │  │  └ item001.png             # アイテムの画像。数字は3桁ゼロ埋めアイテム番号（透過PNG、番号はcsv準拠）
 │  │  ├ player/                    # 背景フォルダ
 │  │  │  ├ Ladder01.png            # プレイヤーの画像。上に登る際に01と02を交互に表示する（透過PNG）
 │  │  │  └ Ladder02.png            # プレイヤーの画像。上に登る際に01と02を交互に表示する（透過PNG）
 │  │  └ ui/                        # UI用の画像フォルダ
 │  │     ├ score/                  # スコア表示用画像フォルダ
 │  │     │  └ Score_Number0.png    # スコア表示用画像。数字はスコアの各桁の値
 │  │     ├ time/                   # タイム表示用画像フォルダ
 │  │     │  ├ Time_Number0.png     # タイム表示用画像。数字はタイムの各桁の値
 │  │     │  └ Time_Numbercolon.png # 分と秒わけるコロン用画像
 │  │     ├ bg.webp                 # タイトル背景（推奨: WebP）
 │  │     └ try.png                 # TRY CLIMB! ボタン（透過PNG）※今は無い
 │  └ score/                        # スコア初期化用フォルダ※今は無い
 │     ├ rankings.seed.json         # スコア初期データ
 │     └ seed.html                  # スコア初期化処理
 ├ src/                             # ★AIが生成するのはここだけ
 └ index.html

# 技術スタック
- ランタイム: Webブラウザ（Canvas）
- フレームワーク: Phaser 3 + TypeScript
- ビルド/開発: Vite（HMR）
- データ管理: public/data/player.csv と public/data/item.csv（Excel編集想定／UTF-8（BOMなし）／ヘッダ必須、カンマ区切り
- items.csvの Id は画像ファイル名に使う。3桁ゼロ埋め（例：item001）
- CSVパーサ：
　- 区切り文字はカンマ（,）固定。TSV（タブ区切り）や自動判定は行わない。
　- エンコーディング：UTF‑8（BOMなし）、ヘッダ必須。
　- 列数整合性：各行でヘッダ列数と一致しない場合、その行は無効化し、行番号付きでUIに警告を表示する。
　- クオート：値に区切り文字（,）・改行・前後空白を含む場合はダブルクオートで囲む。内部の " は "" でエスケープ。
　- スキップ：空行と # で始まる行は読み飛ばす。
　- 厳格バリデーション：各CSVのスキーマに基づき、型・必須・範囲を厳格に検査。違反時は行番号・列名・原因をUIに表示し、当該行を無効化する（致命的な欠損は読み込みを中断）。

- デバイス対応: **PC・スマホ両対応**。画面はスマホ縦準拠（1080x1920）。縦を基準にスケールし、左右に余白を持たせる。
- 存在しないリソースを参照したら、エラーを表示する
- コード上で参照パス方針：CSV/画像とも 絶対パス（/data/..., /images/...） を使用。相対パス禁止。

# タイトル画面
- 背景画像（public/images/ui/bg.webp）を表示。Phaser のアニメーション（パララックス、スクロール、フェード等）で動かす。
- 「TRY CLIMB!」ボタン**PNG(.png)**押下でゲーム画面へ遷移。
- ランキング TOP10 を表示（localStorage から読み込み）。表示形式：順位・名前・スコア。

# リザルト画面
- 「GAME OVER」を常時表示（クリア時でも固定演出）。今回スコアを表示。
- **TOP10入り**なら「!RANK IN!」＋名前入力（半角英数字1–10、`^[A-Za-z0-9]{1,10}$`、前後空白トリム、IME確定）。入力欄の初期値は「YODO」。
- 入力確定で `localStorage['rankings']` に `{name, score, scoreAt}` を保存。  
- upsertは**キー：`scoreAt`**（同一プレイは上書き）。並べ替えは **score降順 → scoreAt昇順**、**先頭10件**に切り詰め。
- 入力欄の初期値は「YODO」。表示はキャンバスの Text（DOM挿入なし）。DOM要素に入れる場合のみ HTML エスケープ（英数字なので見た目は同一）。
- **非ランクイン**は「GAME OVER」を**ボタン**にして押下でタイトルへ（必要なら自動遷移も可）。

# ゲーム画面（In-Game）
## 画面・操作
- 解像度（縦持ち）：**幅1080 × 高さ1920**（プレイヤーY固定、背景が流れる）。
- PC：キーボード（↑／←／→）。
　- **←／→は 1押下＝1ステップ移動（押しっぱなしで連続移動しない）**。  
  - **↑と左右は同時に反応しない**。
  - **↑押下中に左右入力が来たらスクロール停止**（再開は**↑を押し直し**）。  
  - レーンは **0,1,2,3 にクランプ**、**初期レーン＝1**。※必要ならブラウザの矢印スクロールを抑止。
- スマホ：画面下 **20%** を **横3等分（各33.3%幅）**のバーチャルコントローラー（左＝←、中央＝↑、右＝→）。  
- **中央（↑）はタップ中のみ連続スクロール**、**左右はタップ毎に 1ステップ移動**。同時押しはPCと同様に無効。
- その他の入力・ポーズはなし。

## 当たり判定・効果適用
- 当たり判定：画像の矩形をそのまま使う **AABB**。`origin=0.5`（中心基準）。判定サイズは **(CSV の Size)×(displayScale)**。
- 取得条件：プレイヤーは固定Y。矩形が少しでも重なれば取得。
- 多重衝突：同一フレームで複数に触れた場合は **すべて処理**。**優先順位**＝【無敵 → 回復 → ダメージ → スコア】。
- 数値正規化：**HP系／無敵の `Value` は負値を 0 として扱う**。`now` は**ゲームクロック**を用いる。
- 効果適用：
  - **Effect=0（ダメージ）**：プレイヤーが無敵中は効果無効で消滅する。`HP = clamp(HP - max(0,Value), 0, MaxHP)`。
  - **Effect=1（回復）**：最大HP以上回復しない。`HP = clamp(HP + max(0,Value), 0, MaxHP)`。
  - **Effect=2（無敵）**：無敵中に効果を得たら延長する。`invEnd = max(invEnd, now) + max(0,Value)`。
  - **Effect=3（スコア）**：減点はあるが0以下にならない。`score = max(0, score + Value)`
- 効果適用後、該当アイテムは消滅。**無敵中でも接触は成立**し、`Effect=0` 以外は発動して消滅。
- 更新順序：**移動 → 衝突検出 → 効果適用（優先順位順） → 消滅 → UI更新**。

## プレイヤー設定（CSV）
- ファイル：`public/data/player.csv`
- 形式：ヘッダ行＋値行。（カンマ区切り（CSV）、UTF-8（BOMなし）
- 用語と単位
　- screens：進行距離の内部単位（画面枚数）。1screens = 1920px（縦持ち 1080×1920）
　- SecPerScreen：1画面（画面高さの1倍）をスクロールする時間（秒/画面）
　- `Area1~3Sec`と`goalSec`は、遊ぶ時間を表している。↑キーが押されてスクロールしている時間をカウントアップして、それぞれの値を超えたらエリアが変わる
- **カラム（距離はすべて Screen-Height 単位 = SH）**
  - `HP`（int≥1）：初期HP（例：4）。
  - `Size`（px）：当たり判定正方形サイズ（例：48）。
  - `StartTimeSeconds`（int>0）：制限時間（秒）（例：300）。
  - `OnHitStunSeconds`（float≥0）：被弾スタン秒（例：1.0）。
  - `OnHitInvincibleSeconds`（float≥0）：被弾無敵秒（例：3.0）。
　- `SecPerScreen`（float>0）：1画面を進む時間（秒/画面）（例：1.0=1画面1秒。1.2=1画面1.2秒）
  - `Area1Sec`（float>0）：移動した時間がこの値を超えるとArea1が開始(秒)（例：60）
  - `Area2Sec`（float>0）：移動した時間がこの値を超えるとArea2が開始(秒)（例：120）
  - `Area3Sec`（float>0）：移動した時間がこの値を超えるとArea3が開始(秒)（例：180）
  - `goalSec`（float>0）：移動した時間がこの値を超えるとゲームクリア(秒)（例：270）
- **挙動**：
  - ↑をタップしている間、`SecPerScreen`の値で画面がスクロールする。※プレイヤーのY軸は移動しないで、背景やアイテムが下に迫って来る
  - ↑をタップしている間、内部の時間がカウントアップされていき、`Area1Sec`、`Area2Sec`、`Area3Sec`の値を超えるとエリアが変わり、背景や出てくるアイテムの種類が変わる
  - 背景は **地面(Area=0) ⇒ 空(Area=1) ⇒ 宇宙(Area=2) ⇒ ゴール(Area=3)** の順で進行。
  - 同じく、内部の時間が`goalSec`を超えるとゲームクリア
  - プレイヤーは画面下部固定 Y に配置。スマホ版の場合はバーチャルコントローラーのUIが下部にあるので、その領域を確保する必要がある
  - **被弾直後**は `OnHitStunSeconds` の間、入力無効（↑/←/→）。その後 `OnHitInvincibleSeconds` の無敵が付与される。
- **制約（バリデーション）**：
  - 0 < Area1Sec < Area2Sec < Area3Sec < GoalSec ≤ StartTimeSeconds
  - 不整合は 警告ログを出し、必要なら 昇順クリップまたはその行を無効として扱う

## アイテム定義（CSV）
- ファイル：`public/data/item.csv`
- 形式：ヘッダ行＋値行。（カンマ区切り（CSV）、UTF-8（BOMなし）
- **カラム**：
　- `Id`：アイテム番号(ユニークな整数)。画像ファイル名と一致させる
　　- 画像パス：`/images/items/item<Id>.png`（拡張子は `.png` 固定。Idはゼロ埋め3桁。例：item001.png）
  - `Name`：アイテム名（日本語 OK）
  - `Effect`：効果コード  
    - `0` = ダメージ（HP を `Value` 減算。**無敵中は無効**）  
    - `1` = 回復（HP を `Value` 加算）  
    - `2` = 無敵（**`Value` 秒**、ダメージ無効）  
    - `3` = スコア（`score += Value`。**負値なら減点**）
  - `Value`：効果量（無敵＝秒数／スコア＝加点。**HP系に負値が来た場合は 0 扱い**）
  - `Speed`：アイテム移動速度倍率（`ITEM_BASE_SPEED × Speed`。現状 1.0 前提）
  - `Area`：出現ゾーン（`0=地面, 1=空, 2=宇宙, 3=ゴール`）
  - `Weight`：同一ゾーン内の重み（確率比。**0 以下は抽選対象外**）
  - `Size`：画像・当たり判定サイズ（**48 または 96**）
  - `Move`：移動 Type  
    - `0` = 落下（縦 0〜6 の X から下へ直進）  
    - `1` = 右→左（横 0〜3 の Y から右外→左外へ直進）  
    - `2` = 左→右（横 0〜3 の Y から左外→右外へ直進）  
    - `3` = 蛇行（縦 0〜6 の X から下へ **ゆらぎ**つつ移動）
- **スポーン仕様**：
  - **現在ゾーン（Area）と完全一致**する行のみ抽選プールへ。
  - プール内の `Weight` 合計を上限にした **重み付き抽選（Lottery）**で 1 件選ぶ。**Weight ≤ 0 は除外**。
  - 抽選間隔はランダム（例：0.8〜1.8 秒）。定数で調整可能。
- **挙動**：
  - 「`Move`の設定に沿った移動量」と、「プレイヤーの入力によって背景がスクロールした移動量」を合算して移動する
  - プレイヤーとアイテムの画像が重なったら当たり判定成立。アイテム同士が重なった場合は無視する。
  - 同フレームで生成されるアイテムは１つだけ。「生成⇒インターバル⇒生成」を繰り返す
- **蛇行の詳細**：
　- 1.生成された際に、最初の進行方向を「左か右をランダムで決定。ただしレーン外には出ない(0~6)」
　- 2.決定した方向に1レーン分ゆらぎつつ下方向へ移動
　- 3.1レーン分移動したら、次の進行方向を「左か右をランダムで決定。ただしレーン外には出ない(0~6)」
　- 4.２と３を繰り返す
- **テスト容易性**：デバッグモード時は抽選済み **縦/横インデックス**と**再抽選回数**を画面表示（seed も固定可）。

## 出現位置の定義（48px/96px対応）
- 4 レーンの X（`lane0..lane3`）をベースに、**縦 7 か所の X** と **横 4 か所の Y** を定義。
- プレイアブル領域と中心
　- 画面解像度（縦持ち）：`SCREEN.W = 1080`, `SCREEN.H = 1920`
　- **スマホ下部 20%** はバーチャルコントローラ領域：`BOTTOM_UI = 0.2 * SCREEN.H`
　- **プレイアブル領域**：`PLAY_TOP = 0`, `PLAY_BOTTOM = SCREEN.H - BOTTOM_UI`
　- **centerY** は **プレイアブル領域の中心**：`centerY = (PLAY_TOP + PLAY_BOTTOM) / 2`
　- プレイヤーは{縦0, 縦2, 縦4, 縦6}を移動する。{横0, 横1, 横2, 横3}はアイテムは利用できるが、プレイヤーはレーン間の移動で少しの間しか利用できない
- **縦（X座標）**：画面上部・画面外に生成（落下/蛇行用）  
  - `縦0 = lane0`
  - `縦1 = (lane0 + lane1) / 2`  ※**Size=96 用の中点**
  - `縦2 = lane1`
  - `縦3 = (lane1 + lane2) / 2`  ※**Size=96 用の中点**
  - `縦4 = lane2`
  - `縦5 = (lane2 + lane3) / 2`  ※**Size=96 用の中点**
  - `縦6 = lane3`
- **横（Y座標）**：左右生成時の高さ（右→左 / 左→右）  
  - 横0 = 横1よりアイテム 1 個分上  
  - 横1 = 横2よりアイテム 1 個分上  
  - 横2 = 画面の縦幅の中央（centerY）  
  - 横3 = 横2よりアイテム 1 個分下
- **抽選ルール**：
  - Size=48 の縦抽選は {縦0, 縦2, 縦4, 縦6} から一様抽選
  - Size=96 の縦抽選は {縦1, 縦3, 縦5} から一様抽選
  - 横抽選は常に {横0, 横1, 横2, 横3} から一様抽選
- **生成位置**：
　- `Move=0`（落下）：`X = 縦抽選`, `Y = -S`（**上端の外**から出現）
　- `Move=1`（右→左）：`Y = 横抽選`, `X = SCREEN.W + S`（**右外**から出現）
　- `Move=2`（左→右）：`Y = 横抽選`, `X = -S`（**左外**から出現）
　- `Move=3`（蛇行）：`X = 縦抽選`, `Y = -S`（**上端の外**から出現。X は後述の揺らぎで更新）
　- ここで `S = Size`（ピクセル、未スケール）。実描画・判定は `displayScale` を掛けたサイズで行う。

## スコア
- **スコアは整数**で管理し、範囲は `0..99_999_999`（**8桁**）。演算の都度 `score = clamp(score, 0, 99_999_999)`。
- **ゲーム中（プレイ中）**：アイテム効果 **Effect=3** によってのみ増減。時間経過による自動加点はしない。
- **クリア時のみ時間ボーナス**を加算する：  
  - `remainingSec = max(0, StartTimeSeconds - elapsedSec)`  
  - `score += floor(remainingSec * 100)`  
  - 加算後も上限 `99_999_999` を超えないようにクランプ。
  - 加算は**クリア確定時に一度だけ**。HP=0 や制限時間オーバーなどの失敗ケースではボーナス無し。  
  - **重複加算防止**のため、結果確定シーンで `bonusApplied=true` をセットして二重加算を防ぐ。
- スコアの更新は**効果適用（当たり判定の後）**に続けて行い、**UI更新はフレーム末尾**に行う  
  （全体の更新順序：**移動 → 衝突検出 → 効果適用 → 消滅 → UI更新** を厳守）。
- **表示位置**：8桁・**右寄せ**。各桁をスプライトで描画。  
  - 画像：`/images/ui/score/Score_Number0.png` ～ `/images/ui/score/Score_Number9.png`  
  - **画面右上**に、`MARGIN_RIGHT` と `MARGIN_TOP` を空けて固定（**UIはカメラ固定 `scrollFactor=0`、最前面レイヤ**）。  
  - 桁不足は**左側を空白扱い**（ゼロパディングはしない）。ただし**最小1桁（'0'）は必ず描画**。
  - 値が変化したフレームのみ桁スプライトを更新（**毎フレーム再生成はしない**）。

### 残り時間（タイマー）
- 表示値：**「mm:ss」** 形式、**2桁0埋め**（例：`03:07`）。  
  - `remainingSec = max(0, StartTimeSeconds - elapsedSec)`  
  - `mm = floor(remainingSec / 60)`, `ss = floor(remainingSec % 60)`  
  - 「mm:ss」をスプライトで描画。  
  - 数字：`/images/ui/time/Time_Number0.png` ～ `/images/ui/time/Time_Number9.png`  
  - コロン：`/images/ui/time/Time_NumberColon.png`
- **表示位置**：**画面左上**に、`MARGIN_LEFT` と `MARGIN_TOP` を空けて固定（**UIはカメラ固定 `scrollFactor=0`**）。
  - 0埋めは**各桁**の画像選択で実現（`mm` も `ss` も2桁）。
- タイマーは **ゲームオーバー/クリア確定で凍結**（以後変化しない表示）。
- （任意）`mm:ss` の 2 桁仕様を維持するため、`StartTimeSeconds ≤ 5999`（= 99:59）を推奨／超過時の挙動は仕様で定める。

### HP（ライフ）
- **MaxHP = 初期HP**（`player.csv` の `HP`）。  
- 画像：`/images/ui/HP.png` を **MaxHP** 個、**左下**に横並びで表示。  
  - スマホは下部 20% がバーチャルコントローラ領域。**HP はその上端に接する位置**（プレイアブル領域内の左下）。  
  - 現在HPが減った際は**右端から順に非表示**にする（左寄せを維持）。
  - 各アイコン間の余白は `ICON_PAD`（定数）で調整可能。

### レイアウトとプレイアブル領域
- 画面解像度（縦持ち）：`SCREEN.W = 1080`, `SCREEN.H = 1920`  
- スマホの**バーチャルコントローラ領域**：画面下 **20%**。  
  - `BOTTOM_UI = 0.2 * SCREEN.H`  
  - **プレイアブル領域**：`PLAY_TOP = 0`, `PLAY_BOTTOM = SCREEN.H - BOTTOM_UI`
- **UI（スコア/時間）**は画面上部領域内に配置し、  
  **HP** はプレイアブル領域の**左下**（`Y ≈ PLAY_BOTTOM - HP_ICON_H/2 - MARGIN_BOTTOM`）に配置。
- スコア（右上）と時間（左上）が**重ならない**よう、`MARGIN_*` と桁の合計幅から**配置を計算**する。

### 文字要件・更新
- **言語/ロケール非依存**の数値UI（画像）を用いて表示。  
- **UI更新は1フレームに1回**、ゲームロジック更新後に行う（表示ぶれ防止）。
- アセット参照は**絶対パス**のみ（例：`/images/ui/...`）。存在しない場合は**UIに警告**を出し、該当UIパーツを非表示にフォールバック。

## ランキング
- 保存先：`localStorage['rankings']`（JSON）
- スキーマ（v1）：配列 `RankingEntry[]`
  - `name: string`（`^[A-Za-z0-9]{1,10}$`、前後空白トリム）
  - `score: number`（整数、`0..99_999_999`）
  - `scoreAt: number`（**UNIX epoch ms**、1プレイを一意に識別）
- バージョン：必要に応じ `localStorage['rankings_v'] = 1` を併用（将来拡張のため）
- ロード失敗時（JSON 破損・型不正）は **空配列に初期化**し、画面に警告を表示

### ソートと保持件数
- **並び順**：`score desc → scoreAt asc`（同スコアは**先着優先＝古い scoreAt が先**）
- 保持件数：**先頭 10 件**のみ（それ以外は破棄）

### Rank-In 判定
- プレイ終了時に仮エントリ `e = { name: "YODO", score, scoreAt }` を評価
- **Rank-In の条件**：
  - ランキング件数 `< 10` → **無条件でランクイン**
  - 件数 `= 10` → **`score > 10 位の score` のときのみランクイン**  
    （**同点は不可**：先着優先を維持するため。テストが一意）

### 入力（Rank-In のみ発生）
- 画面に「**!RANK IN!**」＋名前入力 UI を表示
- 入力ルール：
  - **半角英数字 1–10**、`^[A-Za-z0-9]{1,10}$`
  - 前後空白は**トリム**。IME 入力は**確定（Enter/確定）**が必要
  - **初期値は「YODO」**
- 表示：**キャンバス Text** で入力内容を描画（DOM入力を使わない）  
  - やむを得ず DOM を使う場合は**HTML エスケープ**を行う（英数字のみでも原則適用）

### 保存（upsert）
- **upsert キー：`scoreAt`**
  - 既存に同一 `scoreAt` があれば**上書き**
  - なければ**追加**
- 保存手順：
  1. 既存配列に対して upsert
  2. **並べ替え**（`score desc → scoreAt asc`）
  3. **先頭 10 件に切り詰め**
  4. `localStorage['rankings']` に JSON 保存
- 例外時は**画面警告**＋処理中断（データ破損を避ける）

### 表示
- **タイトル画面とリザルト画面**：TOP1〜TOP10 を**順位・名前・スコア**の順で一覧表示  
  - スコアは**右寄せ**。桁区切り（`,`）は任意（なしで可）

# 受け入れ条件（Step 3）
- `npm run dev` で起動し、PC/スマホの操作が仕様通り機能。  
- `public/data/item.csv` の編集でゾーン別の出現／頻度（Weight）が反映。  
- 当たり判定で HP／スコア／無敵が更新。被弾直後のスタック＆無敵が動作。  
- ゴール到達 or HP=0 でリザルト表示＆ランキング保存。

# 実装メモ（開発用）
- HP系の `Value` に負値が来た場合は **0 丸め**。  
- `ZONE_BREAKS` でゾーン配分を調整可能。  
- Move=3（蛇行）は `sin` を用いた X の揺れ（振幅/周波数は定数で調整）。  
- 背景の動きは tileSprite のスクロール/レイヤーで演出。  
- 画像は public に静止で配置し、アニメは Phaser で表現（WebP/PNG 推奨、GIF は非推奨）。  
- スマホUIはタップ領域ベース（画像は差し替え可能）。  
- クリア加点は **残り時間 × 100** に統一。

# 注意
- AI は **src フォルダだけ生成する**。public の画像と CSV は人間が用意する。